<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMU Live HUD - UI2</title>
    <link rel="stylesheet" href="css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <style>
        /* Layout Adjustments */
        .grid-sidebar {
            grid-template-columns: 450px 1fr;
            /* Wider control panel as requested */
            gap: 1rem;
        }

        /* Compact Buttons */
        .btn-compact {
            padding: 0.4rem 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
        }

        .pixel-btn {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.8rem;
            position: relative;
        }

        .pixel-btn:hover {
            border-color: var(--accent-cyan);
        }

        .pixel-btn.active {
            background: var(--accent-cyan);
            color: #000;
            border-color: var(--accent-cyan);
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .pixel-btn.busy::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            cursor: wait;
        }

        /* LED Toggle Styling */
        .led-toggle-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            opacity: 0.7;
            transition: all 0.2s;
        }

        .led-toggle-btn:hover:not(:disabled) {
            opacity: 1;
            border-color: var(--text-secondary);
        }

        .led-toggle-btn.active-on {
            background: rgba(0, 255, 102, 0.1);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            opacity: 1;
            box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
            font-weight: 700;
        }

        .led-toggle-btn.active-off {
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            opacity: 1;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.2);
            font-weight: 700;
        }

        /* Chart Toggle */
        .chart-toggle-bar {
            display: flex;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }

        .chart-toggle-item {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .chart-toggle-item:hover {
            color: var(--text-primary);
        }

        .chart-toggle-item.active {
            background: var(--bg-secondary);
            color: var(--accent-cyan);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            /* Taller since single view */
            width: 100%;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .stop-all-btn {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: white;
            font-weight: 800;
            border: 1px solid #aa0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        .stop-all-btn:hover {
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            transform: scale(1.02);
        }

        /* Parameter Inline Labels */
        .param-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .param-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Busy State Overlay */
        .busy-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-cyan);
            font-weight: 700;
            font-size: 1.5rem;
            z-index: 10;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">üïπÔ∏è Smart Live HUD</h1>
            <div class="status-bar">
                <button class="btn btn-sm stop-all-btn" onclick="stopAll()">üõë STOP ALL</button>
                <div class="status-item">
                    <div class="led" id="backendLed"></div>
                    <span>Backend</span>
                </div>
            </div>
        </div>

        <div class="grid-sidebar">
            <!-- LEFT COLUMN: CONTROLS -->
            <div class="left-col">
                <!-- 1. System Connections -->
                <div class="panel p-3">
                    <div class="panel-title mb-2">System Connections</div>
                    <div class="form-group mb-2">
                        <label class="checkbox-label text-small">
                            <input type="checkbox" id="mockMode" checked>
                            Mock Mode
                        </label>
                    </div>
                    <div class="grid-3 mb-2">
                        <div class="text-center">
                            <div class="led" id="smu1Led"></div>
                            <div class="text-small mt-1 text-muted">SMU1</div>
                        </div>
                        <div class="text-center">
                            <div class="led" id="smu2Led"></div>
                            <div class="text-small mt-1 text-muted">SMU2</div>
                        </div>
                        <div class="text-center">
                            <div class="led" id="relaysLed"></div>
                            <div class="text-small mt-1 text-muted">RELAY</div>
                        </div>
                    </div>
                    <div class="btn-row-3 gap-1">
                        <button class="btn btn-primary btn-compact" id="btnConnectSmu1"
                            onclick="connectSMU(1)">CH1</button>
                        <button class="btn btn-primary btn-compact" id="btnConnectSmu2"
                            onclick="connectSMU(2)">CH2</button>
                        <button class="btn btn-primary btn-compact" id="btnConnectRelays"
                            onclick="connectRelays()">Rlys</button>
                    </div>
                </div>

                <!-- 2. Device Selection -->
                <div class="panel p-3">
                    <div class="panel-title mb-2">Device Selection</div>
                    <div class="pixel-grid mb-2" id="pixelGrid">
                        <!-- P1-P6 generated by JS -->
                    </div>
                    <div class="flex-between text-small">
                        <span class="text-muted">Selected:</span>
                        <span id="selectedPixelDisplay" class="text-cyan font-bold">None</span>
                    </div>
                </div>

                <!-- 3. Illumination Control -->
                <div class="panel p-3">
                    <div class="panel-title mb-2">Illumination Control</div>

                    <div class="form-row gap-1 mb-1">
                        <div class="form-group mb-1">
                            <label class="text-small">Wavelength</label>
                            <select id="ledWavelength" class="text-small p-1">
                                <option value="0">None</option>
                                <option value="2">Blue (461)</option>
                                <option value="3">Red (626)</option>
                                <option value="4">Green (522)</option>
                            </select>
                        </div>
                        <div class="form-group mb-1">
                            <label class="text-small">Mode</label>
                            <select id="ledMode" onchange="toggleLedMode()" class="text-small p-1">
                                <option value="current">Current (A)</option>
                                <option value="irradiance">Irrad (W/cm¬≤)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row gap-1 mb-1">
                        <div class="form-group mb-1">
                            <label class="text-small">Driver SMU</label>
                            <select id="ledSmu" class="text-small p-1">
                                <option value="1" selected>CH 1</option>
                                <option value="2">CH 2</option>
                            </select>
                        </div>
                        <div class="form-group mb-1">
                            <label class="text-small">Limit (V)</label>
                            <input type="number" id="ledCompliance" value="9.0" step="0.5" class="text-small p-1">
                        </div>
                    </div>

                    <!-- Current Input -->
                    <div id="ledCurrentInput" class="mb-2">
                        <div class="form-group mb-1">
                            <label class="text-small">LED Current (A)</label>
                            <input type="number" id="ledCurrent" value="0.010" step="0.001" class="text-small p-1">
                        </div>
                    </div>

                    <!-- Irradiance Input -->
                    <div id="ledIrradianceInput" class="mb-2" style="display:none;">
                        <select id="calFileSelect" onchange="updateCalibrationRange()" class="text-small p-1 mb-1"
                            style="width:100%">
                            <option value="">Loading...</option>
                        </select>
                        <div class="text-small text-muted mb-1" id="calRangeInfo" style="font-size:0.7rem">Range: --
                        </div>
                        <input type="number" id="targetIrradiance" value="0.001" step="0.0001"
                            onchange="calculateLedCurrent()" class="text-small p-1" style="width:100%">
                        <div class="text-right text-success text-small mt-1" id="calcResult"></div>
                    </div>

                    <button class="btn btn-outline btn-compact mb-2" id="btnConfigureLed" onclick="configureLED()">‚öôÔ∏è
                        Set Configuration</button>

                    <div class="btn-row gap-1">
                        <button class="btn led-toggle-btn btn-compact" id="btnLedOn" onclick="setLedOutput(true)"
                            disabled>üí° ON</button>
                        <button class="btn led-toggle-btn btn-compact active-off" id="btnLedOff"
                            onclick="setLedOutput(false)">‚ö´ OFF</button>
                    </div>
                </div>

                <!-- 4. IV Sweep -->
                <div class="panel p-3">
                    <div class="panel-title mb-2">IV Sweep & Characterization</div>
                    <div class="form-row gap-1 mb-1">
                        <div class="form-group mb-0">
                            <label class="text-small">Start (V)</label>
                            <input type="number" id="ivStart" value="-1.0" step="0.1" class="text-small p-1">
                        </div>
                        <div class="form-group mb-0">
                            <label class="text-small">Stop (V)</label>
                            <input type="number" id="ivStop" value="1.0" step="0.1" class="text-small p-1">
                        </div>
                    </div>
                    <div class="form-row-3 gap-1 mb-2">
                        <div class="form-group mb-0">
                            <label class="text-small">Points</label>
                            <input type="number" id="ivPoints" value="50" class="text-small p-1">
                        </div>
                        <div class="form-group mb-0">
                            <label class="text-small">Chan</label>
                            <select id="ivChannel" class="text-small p-1">
                                <option value="1">CH1</option>
                                <option value="2" selected>CH2</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label class="text-small">NPLC</label>
                            <input type="number" id="ivNPLC" value="1.0" step="0.1" class="text-small p-1">
                        </div>
                    </div>
                    <div class="form-row gap-1 mb-2">
                        <div class="form-group mb-0">
                            <label class="text-small">Type</label>
                            <select id="ivType" class="text-small p-1">
                                <option value="double">Dbl</option>
                                <option value="single">Sgl</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-warning btn-compact mb-2" id="btnRunSweep" onclick="runIVSweep()">‚ñ∂ RUN IV
                        SWEEP</button>

                    <div class="divider"></div>
                    <div class="form-group mb-1">
                        <label class="text-small">Save Folder</label>
                        <input type="text" id="ivFolder" value="./data" class="text-small p-1" style="width:100%">
                    </div>
                    <div class="form-group mb-1">
                        <label class="text-small">Filename</label>
                        <input type="text" id="ivFilename" placeholder="iv_scan_..." class="text-small p-1"
                            style="width:100%">
                    </div>
                    <button class="btn btn-primary btn-compact" onclick="saveIVData()">üíæ SAVE IV DATA</button>
                </div>
            </div>

            <!-- RIGHT COLUMN: VIEWS -->
            <div class="right-col">

                <!-- View Toggle -->
                <div class="chart-toggle-bar">
                    <div class="chart-toggle-item active" onclick="switchView('monitor')" id="tabMonitor">üìä Live
                        Monitor</div>
                    <div class="chart-toggle-item" onclick="switchView('iv')" id="tabIv">üìà Last IV Scan</div>
                </div>

                <!-- MONITOR VIEW -->
                <div id="viewMonitor" class="view-section active">
                    <div class="panel" id="monitorPanel" style="position:relative;">
                        <div class="flex-between mb-2">
                            <div class="panel-title mb-0">Live Current Monitor</div>
                            <div class="flex-end gap-1">
                                <div class="param-group">
                                    <span class="param-label">Channel</span>
                                    <select id="monChannel" class="text-small p-1" style="width:100px">
                                        <option value="1">CH 1</option>
                                        <option value="2" selected>CH 2</option>
                                    </select>
                                </div>
                                <div class="param-group">
                                    <span class="param-label">Bias (V)</span>
                                    <input type="number" id="monBias" value="0.0" step="0.1" class="text-small p-1"
                                        style="width:90px">
                                </div>
                                <div class="param-group">
                                    <span class="param-label">NPLC</span>
                                    <input type="number" id="monNPLC" value="1.0" step="1.0" class="text-small p-1"
                                        style="width:80px">
                                </div>
                                <div class="param-group">
                                    <span class="param-label">Rate (Hz)</span>
                                    <input type="number" id="monRate" value="10" min="1" max="50" class="text-small p-1"
                                        style="width:80px">
                                </div>
                                <div class="flex-center mt-3">
                                    <button class="btn btn-primary btn-compact" style="width:auto; margin:0;"
                                        onclick="configureMonitor()">SET</button>
                                </div>
                            </div>
                        </div>

                        <!-- Current Readout -->
                        <div class="panel-secondary p-3 border-radius flex-between mb-2">
                            <span class="text-muted font-bold">Current Reading:</span>
                            <div class="flex-center gap-2">
                                <span id="liveCurrentVal" class="text-cyan font-mono text-xl font-bold">-- A</span>
                                <div class="led" id="monitorLed"></div>
                            </div>
                            <button class="btn btn-success btn-compact" id="btnMonStart"
                                style="width:auto; margin:0; padding:0.5rem 1rem;" onclick="toggleMonitor()" disabled>‚ñ∂
                                START</button>
                        </div>

                        <!-- Live Chart -->
                        <div class="chart-wrapper">
                            <canvas id="liveChart"></canvas>
                        </div>

                        <!-- Save Monitor Data -->
                        <div class="flex-end mt-2 gap-1 align-center">
                            <input type="text" id="monFolder" value="./data" class="text-small p-1" style="width:150px"
                                placeholder="Folder">
                            <input type="text" id="monFilename" placeholder="monitor_..." class="text-small p-1"
                                style="width:200px">
                            <button class="btn btn-primary btn-compact" style="width:auto; margin:0;"
                                onclick="saveMonitorData()">üíæ SAVE</button>
                        </div>
                    </div>
                </div>

                <!-- IV VIEW -->
                <div id="viewIv" class="view-section">
                    <div class="panel" style="position:relative;">
                        <div id="ivBusyOverlay" class="busy-overlay">MEASURING...</div>
                        <div class="flex-between mb-2">
                            <div class="panel-title mb-0">Last IV Scan</div>
                            <div class="flex-end">
                                <label class="checkbox-label text-small">
                                    <input type="checkbox" id="ivLogScale" onchange="toggleIvLogScale()"> Log Y Scale
                                </label>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="ivChart"></canvas>
                        </div>
                        <div class="text-center mt-2 text-muted text-small">
                            Run a sweep from the control panel to see data here.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="panel mt-2 p-2">
            <div class="log-box" id="logBox" style="height: 100px; font-size: 0.7rem;"></div>
        </div>
    </div>

    <script>
        // State
        let liveChart = null;
        let ivChart = null;
        let monitorInterval = null;
        let isMonitoring = false;
        let monitorData = [];
        let lastIVData = null;
        let calibrationData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initCharts();
            renderPixelGrid();
            updateFilenames();
            await checkStatus();
            await loadCalibrationFiles();

            // Set default filenames with timestamp
            setInterval(updateFilenames, 60000);
        });

        function switchView(view) {
            // Toggles
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.chart-toggle-item').forEach(el => el.classList.remove('active'));

            // Normalize view string capitalize
            const viewId = view.charAt(0).toUpperCase() + view.slice(1);

            const section = document.getElementById(`view${viewId}`);
            const tab = document.getElementById(`tab${viewId}`);

            if (section) section.classList.add('active');
            if (tab) tab.classList.add('active');

            // Resize charts
            if (view === 'monitor' && liveChart) liveChart.resize();
            if (view === 'iv' && ivChart) ivChart.resize();
        }

        async function setLedOutput(enabled) {
            const channel = parseInt(document.getElementById('ledSmu').value);
            Utils.showToast(enabled ? "Turning LED ON..." : "Turning LED OFF...");
            await UI2.api('POST', '/smu/output', { channel, enabled });

            // UI Toggle States
            const btnOn = document.getElementById('btnLedOn');
            const btnOff = document.getElementById('btnLedOff');

            if (enabled) {
                btnOn.classList.add('active-on');
                btnOff.classList.remove('active-off');
            } else {
                btnOn.classList.remove('active-on');
                btnOff.classList.add('active-off');
            }
        }

        // --- System Controls ---
        async function stopAll() {
            if (confirm('STOP ALL: Turn off outputs, disconnect relays, stop monitoring?')) {
                await UI2.disconnectAll();
                if (isMonitoring) await toggleMonitor(); // Stop frontend polling
                Utils.log('logBox', 'Unknown state - STOP ALL executed', 'error');
                Utils.showToast("System Emergency Stop", 'error');
                // Reset UI state
                document.querySelectorAll('.led.ok').forEach(el => el.classList.remove('ok'));
            }
        }

        async function connectSMU(ch) {
            const mock = document.getElementById('mockMode').checked;
            Utils.showToast(`Connecting SMU CH${ch}...`);
            const res = await UI2.connectSMU(ch, mock);
            if (res.success !== false) {
                document.getElementById(`smu${ch}Led`).classList.add('ok');
                Utils.log('logBox', `SMU CH${ch} Connected`, 'success');
                Utils.showToast(`SMU CH${ch} Connected`, 'success');
            } else {
                Utils.log('logBox', `SMU CH${ch} Fail: ${res.message}`, 'error');
                Utils.showToast(`SMU CH${ch} Fail`, 'error');
            }
        }

        async function connectRelays() {
            const mock = document.getElementById('mockMode').checked;
            Utils.showToast("Connecting Relays...");
            const res = await UI2.connectRelays(mock);
            if (res.success !== false) {
                document.getElementById('relaysLed').classList.add('ok');
                Utils.log('logBox', 'Relays Connected', 'success');
                Utils.showToast("Relays Connected", 'success');
            } else {
                Utils.log('logBox', `Relays Fail: ${res.message}`, 'error');
                Utils.showToast("Relays Fail", 'error');
            }
        }

        function renderPixelGrid() {
            const grid = document.getElementById('pixelGrid');
            let html = '';
            for (let i = 1; i <= 6; i++) {
                html += `<div class="pixel-btn" id="pixBtn${i}" onclick="selectPixel(${i})">P${i}</div>`;
            }
            grid.innerHTML = html;
        }

        async function selectPixel(id) {
            const btn = document.getElementById(`pixBtn${id}`);
            if (btn.classList.contains('active')) return;

            document.querySelectorAll('.pixel-btn').forEach(b => b.classList.add('busy'));
            Utils.showToast(`Switching to Pixel ${id}... (1s delay)`);

            document.querySelectorAll('.pixel-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('selectedPixelDisplay').textContent = `Pixel ${id}`;
            Utils.log('logBox', `Selecting Pixel ${id}...`);

            await UI2.api('POST', '/relays/pixel', { pixel_id: id - 1 });
            document.querySelectorAll('.pixel-btn').forEach(b => b.classList.remove('busy'));
        }

        async function checkStatus() {
            const connected = await UI2.checkBackendConnection();
            document.getElementById('backendLed').classList.toggle('ok', connected);
            if (connected) {
                const status = await UI2.getRunStatus();
                if (status.connected) {
                    document.getElementById('smu1Led').classList.toggle('ok', status.connected);
                }
            }
        }

        function toggleLedMode() {
            const mode = document.getElementById('ledMode').value;
            document.getElementById('ledCurrentInput').style.display = mode === 'current' ? 'block' : 'none';
            document.getElementById('ledIrradianceInput').style.display = mode === 'irradiance' ? 'block' : 'none';
        }

        async function loadCalibrationFiles() {
            const res = await UI2.api('GET', '/data/list', { folder: '.', extension: '.txt' });
            if (res.success && res.files) {
                const calFiles = res.files.filter(f => f.name.startsWith('cal'));
                const sel = document.getElementById('calFileSelect');
                sel.innerHTML = calFiles.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                if (calFiles.length > 0) updateCalibrationRange();
                else sel.innerHTML = '<option value="">No cal files</option>';
            }
        }

        async function updateCalibrationRange() {
            const filename = document.getElementById('calFileSelect').value;
            if (!filename) return;

            // Use the new robust endpoint in backend
            const res = await UI2.getCalibrationData(filename);
            if (res.success && res.irradiances) {
                calibrationData = {
                    currents: res.currents,
                    irradiances: res.irradiances
                };
                const min = Math.min(...res.irradiances);
                const max = Math.max(...res.irradiances);
                document.getElementById('calRangeInfo').textContent = `Range: ${min.toExponential(2)} - ${max.toExponential(2)} W/cm¬≤ (${res.format || 'unknown'})`;
                calculateLedCurrent();
            } else {
                Utils.log('logBox', `Failed to load cal: ${res.message}`, 'error');
            }
        }

        function calculateLedCurrent() {
            if (!calibrationData) return;
            const target = parseFloat(document.getElementById('targetIrradiance').value);
            const { currents, irradiances } = calibrationData;
            let ledI = 0;
            if (target <= irradiances[0]) ledI = currents[0];
            else if (target >= irradiances[irradiances.length - 1]) ledI = currents[currents.length - 1];
            else {
                for (let i = 0; i < irradiances.length - 1; i++) {
                    if (target >= irradiances[i] && target <= irradiances[i + 1]) {
                        const t = (target - irradiances[i]) / (irradiances[i + 1] - irradiances[i]);
                        ledI = currents[i] + t * (currents[i + 1] - currents[i]);
                        break;
                    }
                }
            }
            document.getElementById('ledCurrent').value = ledI.toFixed(6);
            document.getElementById('calcResult').textContent = `‚Üí ${ledI.toFixed(6)} A`;
        }

        async function configureLED() {
            const channel = parseInt(document.getElementById('ledSmu').value);
            const compliance = parseFloat(document.getElementById('ledCompliance').value);
            const current = parseFloat(document.getElementById('ledCurrent').value);
            const wavelength = parseInt(document.getElementById('ledWavelength').value);

            Utils.showToast("Configuring Illumination...");
            if (wavelength > 0) {
                await UI2.api('POST', '/relays/led', { channel_id: wavelength - 1 });
            }

            await UI2.api('POST', '/smu/configure', { channel, compliance, compliance_type: 'VOLT', nplc: 1 });
            await UI2.api('POST', '/smu/source-mode', { channel, mode: 'CURR' });
            await UI2.api('POST', '/smu/set', { channel, value: current });

            document.getElementById('btnLedOn').disabled = false;
            Utils.showToast('LED Configured', 'success');
        }

        async function saveIVData() {
            if (!lastIVData) return alert('No data');
            const folder = document.getElementById('ivFolder').value;
            const filename = document.getElementById('ivFilename').value;

            const res = await UI2.api('POST', '/data/save', {
                data: lastIVData, filename, folder, format: 'csv', append_timestamp: false
            });

            if (res.success) Utils.showToast(`Saved: ${res.filepath}`, 'success');
            else alert(`Save failed: ${res.message}`);
        }

        async function configureMonitor() {
            const params = {
                channel: parseInt(document.getElementById('monChannel').value),
                bias_voltage: parseFloat(document.getElementById('monBias').value),
                nplc: parseFloat(document.getElementById('monNPLC').value),
                rate_hz: parseFloat(document.getElementById('monRate').value),
                compliance: 0.1
            };

            Utils.showToast("Setting Monitor Compliance...");
            await UI2.api('POST', '/monitor/configure', params);
            document.getElementById('btnMonStart').disabled = false;
            document.getElementById('monitorPanel').classList.add('monitor-active');
            Utils.showToast('Monitor Configured', 'success');
        }

        async function toggleMonitor() {
            const btn = document.getElementById('btnMonStart');
            if (isMonitoring) {
                // Stop
                await UI2.api('POST', '/monitor/stop');
                clearInterval(monitorInterval);
                isMonitoring = false;
                btn.textContent = '‚ñ∂ START';
                btn.classList.replace('btn-danger', 'btn-success');
                document.getElementById('monitorLed').classList.remove('running');
                Utils.showToast("Monitor Stopped");
            } else {
                // Start
                await UI2.api('POST', '/monitor/start');
                monitorData = [];
                liveChart.data.labels = [];
                liveChart.data.datasets[0].data = [];
                liveChart.update();

                monitorInterval = setInterval(pollMonitor, 200);
                isMonitoring = true;
                btn.textContent = '‚ñ† STOP';
                btn.classList.replace('btn-success', 'btn-danger');
                document.getElementById('monitorLed').classList.add('running');
                Utils.showToast("Monitor Started", 'success');
            }
        }

        async function pollMonitor() {
            const res = await UI2.api('GET', '/monitor/data', { last_n: 50 });
            if (res.data && res.data.length > 0) {
                const last = res.data[res.data.length - 1];
                document.getElementById('liveCurrentVal').textContent = Utils.formatCurrent(last.current);
                const displayData = res.data;
                const startTime = displayData[0].time;
                liveChart.data.labels = displayData.map(d => (d.time - startTime).toFixed(1));
                liveChart.data.datasets[0].data = displayData.map(d => d.current);
                liveChart.update('none');
            }
        }

        async function saveMonitorData() {
            const res = await UI2.api('GET', '/monitor/data', { last_n: 10000 });
            if (!res.data || res.data.length === 0) return alert('No monitor data');
            const folder = document.getElementById('monFolder').value;
            const filename = document.getElementById('monFilename').value;
            const resSave = await UI2.api('POST', '/data/save', {
                data: res.data, filename, folder, format: 'csv', append_timestamp: false
            });
            if (resSave.success) Utils.showToast(`Saved: ${resSave.filepath}`, 'success');
            else alert(`Save failed: ${resSave.message}`);
        }

        function updateFilenames() {
            const ts = Utils.getTimestamp();
            if (!document.getElementById('ivFilename').value.startsWith('custom_')) {
                document.getElementById('ivFilename').value = `iv_scan_${ts}`;
            }
            if (!document.getElementById('monFilename').value.startsWith('custom_')) {
                document.getElementById('monFilename').value = `monitor_${ts}`;
            }
        }

        async function runIVSweep() {
            const params = {
                channel: parseInt(document.getElementById('ivChannel').value),
                start: parseFloat(document.getElementById('ivStart').value),
                stop: parseFloat(document.getElementById('ivStop').value),
                points: parseInt(document.getElementById('ivPoints').value),
                sweep_type: document.getElementById('ivType').value,
                scale: 'linear',
                nplc: parseFloat(document.getElementById('ivNPLC').value) || 0.1,
                delay: 0.01,
                compliance: 0.05
            };

            const btn = document.getElementById('btnRunSweep');
            const overlay = document.getElementById('ivBusyOverlay');

            btn.disabled = true;
            btn.textContent = "‚åõ MEASURING...";
            overlay.style.display = 'flex';

            switchView('iv'); // Auto switch to IV view
            Utils.log('logBox', 'Starting IV sweep...');

            try {
                const res = await UI2.api('POST', '/smu/sweep', params);
                if (res.success !== false && res.results) {
                    lastIVData = res.results;
                    plotIV(res.results);
                    Utils.log('logBox', `IV sweep complete (${res.results.length} pts)`, 'success');
                    Utils.showToast("IV Sweep Complete", 'success');
                } else {
                    Utils.log('logBox', `IV sweep failed: ${res.message}`, 'error');
                    Utils.showToast("IV Sweep Failed", 'error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = "‚ñ∂ RUN IV SWEEP";
                overlay.style.display = 'none';
            }
        }

        function plotIV(data) {
            ivChart.data.datasets[0].data = data.map(d => ({ x: d.voltage, y: d.current }));
            ivChart.update();
        }

        function toggleIvLogScale() {
            const isLog = document.getElementById('ivLogScale').checked;
            ivChart.options.scales.y.type = isLog ? 'logarithmic' : 'linear';

            // For log scale, ensure we only plot absolute values or non-zero positive
            if (isLog && lastIVData) {
                ivChart.data.datasets[0].data = lastIVData.map(d => ({
                    x: d.voltage,
                    y: Math.abs(d.current) || 1e-12
                }));
            } else if (lastIVData) {
                ivChart.data.datasets[0].data = lastIVData.map(d => ({ x: d.voltage, y: d.current }));
            }

            ivChart.update();
        }

        function initCharts() {
            const ctxLive = document.getElementById('liveChart').getContext('2d');
            liveChart = new Chart(ctxLive, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Current (A)', data: [], borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.1)', borderWidth: 2, tension: 0.1, pointRadius: 0, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: true, grid: { color: '#333' }, ticks: { color: '#888' } }, y: { display: true, grid: { color: '#333' }, ticks: { color: '#888' } } }, plugins: { legend: { display: false } } }
            });

            const ctxIV = document.getElementById('ivChart').getContext('2d');
            ivChart = new Chart(ctxIV, {
                type: 'scatter',
                data: { datasets: [{ label: 'IV Curve', data: [], borderColor: '#00ff66', backgroundColor: 'rgba(0,255,102,0.1)', showLine: true, pointRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Voltage (V)' }, grid: { color: '#333' }, ticks: { color: '#888' } }, y: { title: { display: true, text: 'Current (A)' }, grid: { color: '#333' }, ticks: { color: '#888' } } } }
            });
        }
    </script>
</body>

</html>