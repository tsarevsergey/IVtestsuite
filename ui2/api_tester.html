<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester - UI2</title>
    <link rel="stylesheet" href="css/theme.css">
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <style>
        .tester-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 120px);
        }

        .endpoint-list {
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            padding-right: 1rem;
        }

        .category-group {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .endpoint-item {
            display: block;
            padding: 0.6rem 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            border: 1px solid transparent;
        }

        .endpoint-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .endpoint-item.active {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-cyan);
            border-color: rgba(0, 212, 255, 0.2);
        }

        .endpoint-item .method {
            font-size: 0.65rem;
            font-weight: 800;
            margin-right: 0.5rem;
            padding: 2px 4px;
            border-radius: 3px;
            background: #333;
            color: #fff;
        }

        .method-GET {
            background: #61affe !important;
        }

        .method-POST {
            background: #49cc90 !important;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .preview-section {
            background: #000;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .preview-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: block;
        }

        .response-section {
            background: #0d0d12;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }

        pre {
            margin: 0;
            color: var(--accent-green);
            white-space: pre-wrap;
            word-break: break-all;
        }

        .syntax-key {
            color: #f07178;
        }

        .syntax-string {
            color: #c3e88d;
        }

        .syntax-number {
            color: #f78c6c;
        }

        .syntax-boolean {
            color: #ffcb6b;
        }

        .syntax-null {
            color: #eeffff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ðŸ§ª API Tester</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="led" id="backendLed"></div>
                    <span>Backend</span>
                </div>
            </div>
        </div>

        <div class="tester-layout">
            <!-- Left: Sidebar -->
            <div class="endpoint-list" id="endpointSidebar">
                <!-- Generated by JS -->
            </div>

            <!-- Right: Content -->
            <div class="main-content-scroll" style="overflow-y: auto; padding-right: 0.5rem;">
                <div id="noSelection" style="padding: 4rem; text-align: center; color: var(--text-muted);">
                    <h2>Select an endpoint to begin</h2>
                    <p>Testing backend functionality made easy.</p>
                </div>

                <div id="testerContent" style="display: none;">
                    <div class="panel p-4 mb-3">
                        <div class="flex-between mb-4">
                            <div>
                                <h2 id="endpointTitle" class="mb-1">Endpoint Name</h2>
                                <code id="endpointPath" class="text-cyan">/path/to/api</code>
                            </div>
                            <button class="btn btn-primary" onclick="executeRequest()" id="btnExecute">ðŸš€ EXECUTE
                                REQUEST</button>
                        </div>

                        <div id="paramSection">
                            <div class="panel-title mb-3">Payload Parameters</div>
                            <div class="param-grid" id="paramGrid">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>

                    <div class="grid-2 gap-3">
                        <div>
                            <div class="panel p-3">
                                <div class="panel-title mb-2">ðŸ“„ Request Preview</div>
                                <div class="preview-section">
                                    <span class="preview-label">URL</span>
                                    <div id="previewUrl" class="mb-3">http://localhost:5000/api</div>
                                    <span class="preview-label">Method</span>
                                    <div id="previewMethod" class="mb-3">POST</div>
                                    <span class="preview-label">JSON Payload</span>
                                    <pre id="previewPayload">{}</pre>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="panel p-3">
                                <div class="panel-title mb-2">âš¡ Response</div>
                                <div class="response-section" id="responseBox">
                                    <pre id="responseContent" class="text-muted">No request executed yet.</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ENDPOINTS = {
            "Status": {
                "Health Check": { method: "GET", path: "/health", params: {} },
                "Get Status": { method: "GET", path: "/status", params: {} },
                "Abort Run": { method: "POST", path: "/abort", params: {} },
                "Reset State": { method: "POST", path: "/reset", params: {} },
                "Arm System": { method: "POST", path: "/arm", params: {} },
                "Start Run": { method: "POST", path: "/start", params: {} },
                "Complete Run": { method: "POST", path: "/complete", params: {} },
            },
            "SMU": {
                "Get SMU Status": { method: "GET", path: "/smu/status", params: {} },
                "Connect SMU": {
                    method: "POST",
                    path: "/smu/connect",
                    params: {
                        address: { type: "str", default: "USB0::2391::35864::MY51141849::0::INSTR" },
                        mock: { type: "bool", default: true },
                        channel: { type: "select", options: [1, 2], default: 1 },
                        smu_type: { type: "select", options: ["auto", "keysight_b2901", "keysight_b2902", "keithley_2400"], default: "auto" },
                    }
                },
                "Disconnect SMU": { method: "POST", path: "/smu/disconnect", params: {} },
                "Configure SMU": {
                    method: "POST",
                    path: "/smu/configure",
                    params: {
                        compliance: { type: "float", default: 0.1, min: 0.0 },
                        compliance_type: { type: "select", options: ["CURR", "VOLT"], default: "CURR" },
                        nplc: { type: "float", default: 1.0, min: 0.01, max: 100.0 },
                        channel: { type: "select", options: [1, 2], default: 1 },
                    }
                },
                "Set Source Mode": {
                    method: "POST",
                    path: "/smu/source-mode",
                    params: {
                        mode: { type: "select", options: ["VOLT", "CURR"], default: "VOLT" },
                        channel: { type: "select", options: [1, 2], default: 1 }
                    }
                },
                "Set Value": {
                    method: "POST",
                    path: "/smu/set",
                    params: {
                        value: { type: "float", default: 0.0 },
                        channel: { type: "select", options: [1, 2], default: 1 }
                    }
                },
                "Control Output": {
                    method: "POST",
                    path: "/smu/output",
                    params: {
                        enabled: { type: "bool", default: false },
                        channel: { type: "select", options: [1, 2], default: 1 }
                    }
                },
                "Single Measurement": {
                    method: "GET",
                    path: "/smu/measure",
                    params: {
                        channel: { type: "select", options: [1, 2], default: 1 }
                    }
                },
                "Run IV Sweep": {
                    method: "POST",
                    path: "/smu/sweep",
                    params: {
                        start: { type: "float", default: 0.0 },
                        stop: { type: "float", default: 8.0 },
                        points: { type: "int", default: 11, min: 2, max: 1000 },
                        compliance: { type: "float", default: 0.01, min: 0.0 },
                        delay: { type: "float", default: 0.05, min: 0.0 },
                        scale: { type: "select", options: ["linear", "log"], default: "linear" },
                        direction: { type: "select", options: ["forward", "backward"], default: "forward" },
                        sweep_type: { type: "select", options: ["single", "double"], default: "single" },
                        channel: { type: "select", options: [1, 2], default: 1 },
                    }
                },
                "List Sweep": {
                    method: "POST",
                    path: "/smu/list-sweep",
                    params: {
                        points: { type: "list_float", default: "0,1,2,5,8,0" },
                        source_mode: { type: "select", options: ["VOLT", "CURR"], default: "VOLT" },
                        compliance: { type: "float", default: 0.1, min: 0.0 },
                        nplc: { type: "float", default: 1.0, min: 0.01, max: 100.0 },
                        delay: { type: "float", default: 0.1, min: 0.0 },
                        channel: { type: "select", options: [1, 2], default: 1 },
                    }
                },
            },
            "Relays": {
                "Get Relay Status": { method: "GET", path: "/relays/status", params: {} },
                "Connect Relays": {
                    method: "POST",
                    path: "/relays/connect",
                    params: {
                        port: { type: "str", default: "COM3" },
                        mock: { type: "bool", default: true },
                    }
                },
                "Disconnect Relays": { method: "POST", path: "/relays/disconnect", params: {} },
                "Select Pixel": {
                    method: "POST",
                    path: "/relays/pixel",
                    params: { pixel_id: { type: "int", default: 0, min: 0, max: 7 } }
                },
                "Select LED": {
                    method: "POST",
                    path: "/relays/led",
                    params: { channel_id: { type: "int", default: 0, min: 0, max: 3 } }
                },
                "All Relays Off": { method: "POST", path: "/relays/all-off", params: {} },
            },
            "Protocol": {
                "Run Protocol": {
                    method: "POST",
                    path: "/protocol/run",
                    params: {
                        pixels: { type: "list_int", default: "0,1" },
                        modes: { type: "multiselect", options: ["dark", "light"], default: ["dark", "light"] },
                        led_channel: { type: "int", default: 0, min: 0, max: 3 },
                        start_voltage: { type: "float", default: 0.0 },
                        stop_voltage: { type: "float", default: 8.0 },
                        num_points: { type: "int", default: 41, min: 2, max: 500 },
                        compliance: { type: "float", default: 0.1, min: 0.0 },
                        delay: { type: "float", default: 0.1, min: 0.0 },
                        output_dir: { type: "str", default: "data" },
                        sample_name: { type: "str", default: "sample_001" },
                    }
                },
                "Get Protocol Status": { method: "GET", path: "/protocol/status", params: {} },
                "Abort Protocol": { method: "POST", path: "/protocol/abort", params: {} },
            }
        };

        let selectedCategory = null;
        let selectedEndpoint = null;
        let currentPayload = {};

        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar();
            checkStatus();
            setInterval(checkStatus, 5000);
        });

        async function checkStatus() {
            const connected = await UI2.checkBackendConnection();
            document.getElementById('backendLed').classList.toggle('ok', connected);
        }

        function renderSidebar() {
            const sidebar = document.getElementById('endpointSidebar');
            let html = '';

            for (const [cat, endpoints] of Object.entries(ENDPOINTS)) {
                html += `<div class="category-group">`;
                html += `<div class="category-title">${cat}</div>`;
                for (const [name, cfg] of Object.entries(endpoints)) {
                    html += `
                        <div class="endpoint-item" onclick="selectEndpoint('${cat}', '${name}')" id="btn-${cat}-${name.replace(/\s+/g, '')}">
                            <span class="method method-${cfg.method}">${cfg.method}</span>
                            ${name}
                        </div>
                    `;
                }
                html += `</div>`;
            }
            sidebar.innerHTML = html;
        }

        function selectEndpoint(cat, name) {
            selectedCategory = cat;
            selectedEndpoint = name;
            const cfg = ENDPOINTS[cat][name];

            // Update UI
            document.querySelectorAll('.endpoint-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${cat}-${name.replace(/\s+/g, '')}`).classList.add('active');

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('testerContent').style.display = 'block';

            document.getElementById('endpointTitle').textContent = name;
            document.getElementById('endpointPath').textContent = cfg.path;
            document.getElementById('paramSection').style.display = Object.keys(cfg.params).length > 0 ? 'block' : 'none';

            renderParams(cfg.params);
            updatePreview();
        }

        function renderParams(params) {
            const grid = document.getElementById('paramGrid');
            grid.innerHTML = '';
            currentPayload = {};

            for (const [key, info] of Object.entries(params)) {
                const group = document.createElement('div');
                group.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = key;
                group.appendChild(label);

                let input;
                if (info.type === 'bool') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.checked = info.default;
                    input.onchange = () => { currentPayload[key] = input.checked; updatePreview(); };
                    currentPayload[key] = info.default;
                } else if (info.type === 'select' || info.type === 'multiselect') {
                    input = document.createElement('select');
                    if (info.type === 'multiselect') input.multiple = true;
                    info.options.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt;
                        o.textContent = opt;
                        if (opt === info.default) o.selected = true;
                        input.appendChild(o);
                    });
                    input.onchange = () => {
                        if (info.type === 'multiselect') {
                            currentPayload[key] = Array.from(input.selectedOptions).map(o => o.value);
                        } else {
                            currentPayload[key] = input.value;
                        }
                        updatePreview();
                    };
                    currentPayload[key] = info.default;
                } else if (info.type === 'int' || info.type === 'float') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = info.default;
                    if (info.min !== undefined) input.min = info.min;
                    if (info.max !== undefined) input.max = info.max;
                    if (info.type === 'float') input.step = '0.01';
                    input.oninput = () => { currentPayload[key] = parseFloat(input.value); updatePreview(); };
                    currentPayload[key] = info.default;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = info.default;
                    input.oninput = () => {
                        if (info.type === 'list_int') {
                            currentPayload[key] = input.value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                        } else if (info.type === 'list_float') {
                            currentPayload[key] = input.value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                        } else {
                            currentPayload[key] = input.value;
                        }
                        updatePreview();
                    };
                    currentPayload[key] = info.default;
                    // Handle list conversion immediately
                    if (info.type === 'list_int') currentPayload[key] = info.default.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                    if (info.type === 'list_float') currentPayload[key] = info.default.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                }

                group.appendChild(input);
                grid.appendChild(group);
            }
        }

        function updatePreview() {
            const cfg = ENDPOINTS[selectedCategory][selectedEndpoint];
            document.getElementById('previewUrl').textContent = `${UI2.BASE_URL}${cfg.path}`;
            document.getElementById('previewMethod').textContent = cfg.method;
            document.getElementById('previewPayload').textContent = cfg.method === 'POST' ? JSON.stringify(currentPayload, null, 2) : 'No payload for GET';
        }

        async function executeRequest() {
            const cfg = ENDPOINTS[selectedCategory][selectedEndpoint];
            const btn = document.getElementById('btnExecute');
            const responseBox = document.getElementById('responseContent');

            btn.disabled = true;
            btn.textContent = 'Executing...';
            responseBox.textContent = 'Requesting...';
            responseBox.className = 'text-muted';

            try {
                const res = await UI2.api(cfg.method, cfg.path, cfg.method === 'POST' ? currentPayload : currentPayload);
                responseBox.innerHTML = syntaxHighlight(res);
                Utils.showToast(`${selectedEndpoint} executed`, res.success !== false ? 'success' : 'error');
            } catch (e) {
                responseBox.textContent = `Error: ${e.message}`;
                responseBox.className = 'text-danger';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸš€ EXECUTE REQUEST';
            }
        }

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'syntax-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'syntax-key';
                    } else {
                        cls = 'syntax-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'syntax-boolean';
                } else if (/null/.test(match)) {
                    cls = 'syntax-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>

</html>